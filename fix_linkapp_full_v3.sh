#!/bin/bash
# =====================================================
# ๐ง fix_linkapp_full_v3.sh โ ุฅุตูุงุญ + ุชุญููู ุดุงูู ููุดุฑูุน LinkApp
# =====================================================

set -e

# ุฅุนุฏุงุฏุงุช ุนุงูุฉ
PROJECT_DIR="$HOME/AndroidStudioProjects/LinkApp"
BACKUP_DIR="$HOME/fix_backups/$(date +%Y%m%d-%H%M%S)"
GITHUB_USER="Devloperjava"
REPO_NAME="LinkApp"

echo "[INFO] ๐ ุจุฏุก ุนูููุฉ ุงูุฅุตูุงุญ ูุงูุชุญููู ุงููุงูู ูููุดุฑูุน..."
cd "$PROJECT_DIR" || { echo "[ERROR] โ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฌูุฏ ุงููุดุฑูุน."; exit 1; }

# =====================================================
# ๐๏ธ 1. ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุฐูู (ุชุฌุงูู ูููุงุช ุงููุธุงู)
# =====================================================
echo "[INFO] ๐๏ธ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุขููุฉ ุฅูู: $BACKUP_DIR"
mkdir -p "$BACKUP_DIR"

tar --exclude="$HOME/.cache" \
    --exclude="$HOME/.gradle" \
    --exclude="**/.git" \
    --exclude="**/.idea" \
    --exclude="**/build" \
    --exclude="**/.port" \
    --exclude="**/local.properties" \
    -czf "$BACKUP_DIR/project_backup.tar.gz" "$PROJECT_DIR" \
    && echo "[OK] โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ." \
    || echo "[WARN] โ๏ธ ุจุนุถ ูููุงุช ุงููุธุงู ุชู ุชุฌุงูููุง ุชููุงุฆููุง (ุฃูุฑ ุทุจูุนู)."

# =====================================================
# ๐งน 2. ุชูุธูู ุงููุดุฑูุน
# =====================================================
echo "[INFO] ๐งน ุชูุธูู ุงููุดุฑูุน ูู ุงููููุงุช ุงููุฏููุฉ..."
./gradlew clean || echo "[WARN] โ๏ธ Gradle ูู ูุชู ุชููุฆุชู ุจุนุฏ."

# =====================================================
# ๐งฉ 3. ุชุญุฏูุซ ุงูุชุจุนูุงุช
# =====================================================
echo "[INFO] ๐ง ูุฒุงููุฉ ุงูุชุจุนูุงุช..."
./gradlew --refresh-dependencies || echo "[WARN] โ๏ธ ูุดู ุงูุชุญุฏูุซ ุงูุฌุฒุฆู ููุชุจุนูุงุช."

# =====================================================
# ๐งช 4. ุงุฎุชุจุงุฑ ุงูุจูุงุก
# =====================================================
echo "[INFO] ๐งช ุงุฎุชุจุงุฑ ุจูุงุก ุงููุดุฑูุน..."
if ./gradlew assembleDebug; then
    echo "[OK] โ ุงูุจูุงุก ูุงุฌุญ!"
else
    echo "[ERROR] โ ูุดู ุงูุจูุงุก! ุฌุงุฑู ูุญุต ุงูุฃุณุจุงุจ..."
    ./gradlew build --stacktrace || true
fi

# =====================================================
# ๐ง 5. ุชุญููู ุงูุฃููุงุฏ (Lint + Kotlin + Detekt)
# =====================================================
echo "[INFO] ๐ง ูุญุต ุงูููุฏ ุจุงุณุชุฎุฏุงู Lint ู Detekt..."
if ./gradlew lint || ./gradlew detekt; then
    echo "[OK] โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ุญุฑุฌุฉ ูู ุงูููุฏ."
else
    echo "[WARN] โ๏ธ ุชู ุงูุนุซูุฑ ุนูู ุชุญุฐูุฑุงุช ุฃู ูุดุงูู ูู ุงูููุฏ (ุฑุงุฌุน reports/)."
fi

# =====================================================
# ๐งฉ 6. ูุญุต ุงูุฃููุงุฏ ุงูููุทููุฉ (Kotlin compiler)
# =====================================================
echo "[INFO] ๐ ูุญุต ููุทู Kotlin..."
if ./gradlew compileDebugKotlin; then
    echo "[OK] โ ููุฏ Kotlin ูุธูู ูุณููู."
else
    echo "[ERROR] โ ูุดุงูู ูู ุฃููุงุฏ Kotlin โ ุฑุงุฌุน ุงูุณุฌูุงุช ุฃุนูุงู."
fi

# =====================================================
# ๐งช 7. ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ Unit Tests (ุฅู ูุฌุฏุช)
# =====================================================
if [ -d "app/src/test" ]; then
    echo "[INFO] ๐งช ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ..."
    ./gradlew testDebugUnitTest || echo "[WARN] โ๏ธ ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุดูุช."
else
    echo "[INFO] ๐ค ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ูุญุฏุฉ ุจุนุฏ (ุชุฌุงูุฒ)."
fi

# =====================================================
# ๐ 8. ุฅุนุฏุงุฏ GitHub ูุฏูุน ุงูุชุบููุฑุงุช
# =====================================================
echo "[INFO] ๐ ุฅุนุฏุงุฏ GitHub..."
git init
git branch -M main
git remote remove origin 2>/dev/null || true
git remote add origin "https://github.com/$GITHUB_USER/$REPO_NAME.git"

git add .
git commit -m "๐ง ุฅุตูุงุญ ูุชุญููู ุชููุงุฆู ุดุงูู $(date +%Y-%m-%d_%H:%M)" || echo "[INFO] ูุง ุชุบููุฑุงุช ุฌุฏูุฏุฉ ููุฑูุน."
git push -u origin main --force && echo "[OK] โ ุชู ุฑูุน ุงููุดุฑูุน ุจูุฌุงุญ ุฅูู GitHub."

# =====================================================
# ๐ฏ 9. ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ
# =====================================================
echo
echo "๐ฏ ุชู ุฅุตูุงุญ ูุชุญููู ูุดุฑูุน LinkApp ุจุงููุงูู ุจูุฌุงุญ!"
echo "๐ฆ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูุญููุธุฉ ูู: $BACKUP_DIR"
echo "๐ง ุชูุงุฑูุฑ Lint ู Detekt ููุฌูุฏุฉ ูู: app/build/reports/"
echo "๐ ุชุญูู ูู ูุณุชูุฏุนู ููุง: https://github.com/$GITHUB_USER/$REPO_NAME"
echo "โจ ุงูุชุญ ุงููุดุฑูุน ุงูุขู ูู Android Studio โ ุฌุงูุฒ ููุจูุงุก ูุงูุชุฌุฑุจุฉ."
